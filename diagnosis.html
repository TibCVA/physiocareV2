<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#37A7C4">
    <title>PhysioCare - Analyse & Diagnostic</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="js/patient-storage.js"></script>
    <script src="js/patient-manager.js"></script>
<style>
    :root {
        --brand-light: #37A7C4;
        --brand-medium: #2C89A0;
        --brand-dark: #1E5F6E;
        --pure-white: #FFFFFF;
        --elevation-1: 0 1px 3px rgba(30, 95, 110, 0.05), 0 1px 2px rgba(30, 95, 110, 0.1);
        --elevation-2: 0 4px 6px rgba(30, 95, 110, 0.1), 0 2px 4px rgba(30, 95, 110, 0.06);
        --elevation-3: 0 10px 20px rgba(30, 95, 110, 0.15), 0 3px 6px rgba(30, 95, 110, 0.1);
        --safe-top: env(safe-area-inset-top, 47px);
        --safe-bottom: env(safe-area-inset-bottom, 34px);
    }

    body {
        background: #F5F9FA;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    .nav-blur {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-bottom: 1px solid rgba(55, 167, 196, 0.1);
    }

    .form-section {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 16px;
        box-shadow: var(--elevation-1);
        border: 1px solid rgba(55, 167, 196, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .form-section:hover {
        transform: translateY(-2px);
        box-shadow: var(--elevation-2);
    }

    .ios-input {
        width: 100%;
        padding: 12px;
        border: 1px solid rgba(55, 167, 196, 0.2);
        border-radius: 12px;
        margin: 8px 0;
        font-size: 16px;
        background: white;
        -webkit-appearance: none;
        color: var(--brand-dark);
        transition: all 0.3s ease;
    }

    .ios-input:focus {
        border-color: var(--brand-light);
        outline: none;
        box-shadow: 0 0 0 3px rgba(55, 167, 196, 0.1);
    }

    .ios-input::placeholder {
        color: rgba(30, 95, 110, 0.5);
    }

    .start-button {
        background: linear-gradient(135deg, var(--brand-light), var(--brand-medium));
        border-radius: 12px;
        padding: 16px 32px;
        color: white;
        font-weight: 600;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: var(--elevation-2);
        border: none;
        cursor: pointer;
    }

    .start-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(to bottom,
            rgba(255, 255, 255, 0.2),
            rgba(255, 255, 255, 0));
        transition: opacity 0.3s ease;
    }

    .start-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--elevation-3);
    }

    .start-button:active {
        transform: scale(0.98);
        box-shadow: var(--elevation-1);
    }

    .loading-ring {
        width: 64px;
        height: 64px;
        border: 4px solid rgba(55, 167, 196, 0.1);
        border-left-color: var(--brand-light);
        border-radius: 50%;
        animation: rotate 1s linear infinite;
    }

    @keyframes rotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .diagnostic-item {
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(55, 167, 196, 0.2);
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .diagnostic-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--elevation-2);
    }

    .diagnostic-item.primary {
        background: linear-gradient(135deg, var(--brand-light), var(--brand-medium));
        color: white;
        border: none;
        box-shadow: var(--elevation-2);
    }

    .diagnostic-item.primary:hover {
        box-shadow: var(--elevation-3);
    }

    .probability-bar {
        height: 4px;
        background: rgba(55, 167, 196, 0.1);
        border-radius: 2px;
        overflow: hidden;
        margin-top: 8px;
    }

    .diagnostic-item.primary .probability-bar {
        background: rgba(255, 255, 255, 0.2);
    }

    .probability-bar-fill {
        height: 100%;
        background: var(--brand-light);
        transition: width 1s ease;
    }

    .diagnostic-item.primary .probability-bar-fill {
        background: white;
    }

    .expand-button {
        background: rgba(55, 167, 196, 0.1);
        border: none;
        padding: 12px 16px;
        border-radius: 8px;
        font-weight: 500;
        color: var(--brand-dark);
        margin-top: 16px;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .expand-button:hover {
        background: rgba(55, 167, 196, 0.15);
    }

    .diagnostic-item.primary .expand-button {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .diagnostic-item.primary .expand-button:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .diagnostic-details {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s ease-out;
    }

    .diagnostic-details.expanded {
        max-height: 1000px;
        opacity: 1;
        transform: translateY(0);
        margin-top: 20px;
    }

    .details-section {
        border-left: 3px solid var(--brand-light);
        padding-left: 16px;
        margin-top: 20px;
    }

    .diagnostic-item.primary .details-section {
        border-left-color: rgba(255, 255, 255, 0.5);
    }

    .details-section:first-child {
        margin-top: 0;
    }

    .progress-bar {
        height: 3px;
        background: rgba(55, 167, 196, 0.1);
        margin: 8px 0;
    }

    .progress-bar-fill {
        height: 100%;
        width: 83.33%;
        background: linear-gradient(to right, var(--brand-light), var(--brand-medium));
        transition: width 0.3s ease;
    }

    .validation-button.secondary {
        background: rgba(55, 167, 196, 0.1);
        color: var(--brand-dark);
        box-shadow: none;
    }
    
    .validation-button.secondary:hover {
        background: rgba(55, 167, 196, 0.2);
    }

    @media (prefers-color-scheme: dark) {
        body {
            background: #0A1214;
            color: white;
        }

        .nav-blur {
            background: rgba(10, 18, 20, 0.85);
            border-bottom-color: rgba(55, 167, 196, 0.2);
        }

        .form-section {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(55, 167, 196, 0.2);
        }

        .ios-input {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(55, 167, 196, 0.2);
        }

        .ios-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .diagnostic-item {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(55, 167, 196, 0.2);
        }

        .expand-button {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .expand-button:hover {
            background: rgba(255, 255, 255, 0.15);
        }
    }
</style>
</head>
    <body class="min-h-screen">
        <nav class="nav-blur fixed w-full z-50">
            <div class="max-w-5xl mx-auto px-4">
                <div class="flex items-center justify-between h-[calc(44px+var(--safe-top))] pt-[var(--safe-top)]">
                    <a href="documents.html" class="nav-button flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        Retour
                    </a>
                    <span class="font-semibold">Patient (5/6)</span>
                    <a href="treatment.html" class="nav-button primary">Suivant</a>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>
        </nav>
    
        <main class="pt-[calc(84px+var(--safe-top))] pb-[calc(20px+var(--safe-bottom))] px-6">
            <div class="max-w-xl mx-auto space-y-6">
            <!-- Section Remarques -->
            <div id="remarksSection" class="form-section">
                <h2 class="text-lg font-semibold text-[var(--brand-dark)] mb-4">Remarques</h2>
                <textarea id="remarks" class="ios-input h-32" placeholder="Ajoutez vos observations..."></textarea>
                <button id="startAnalysis" class="start-button w-full mt-4">
                    Démarrer l'analyse
                </button>
            </div>
    
            <!-- Section Chargement -->
            <div id="loadingSection" class="form-section text-center hidden">
                <div class="loading-ring mx-auto mb-4"></div>
                <p class="text-[var(--brand-dark)]">Analyse en cours...</p>
            </div>
    
            <!-- Section Résultats -->
            <div id="resultsSection" class="hidden">
                <div id="diagnosticResults"></div>
            </div>
    
            <!-- Section Validation -->
            <div id="validationSection" class="form-section text-center hidden">
                <button class="validation-button start-button w-full">Confirmer et continuer</button>
                <button class="validation-button secondary mt-3">Recommencer l'analyse</button>
            </div>
    <script>
        const Logger = {
            debug: (component, message, data) => {
                console.log(`[${component}]`, message, data);
            },
            error: (component, message, error) => {
                console.error(`[ERROR][${component}]`, message, error);
            },
            warn: (component, message, data) => {
                console.warn(`[WARN][${component}]`, message, data);
            }
        };
        const CONFIG = {
            api: 'https://physiocare-api.b00135522.workers.dev',
            storage: {
                keys: {
                    diagnosis: 'patient_diagnosis',
                    personalInfo: 'patient_personal_info',
                    activity: 'patient_physical_activity',
                    symptoms: 'patient_symptoms',
                    documents: 'patient_documents'
                }
            },
            retries: {
                maxAttempts: 3,
                baseDelay: 1000,
                maxDelay: 10000
            },
            timeouts: {
                request: 30000,
                global: 60000
            }
        };

        class DiagnosticManager {
            constructor() {
                this.storage = window.PatientStorageManager;
                this.abortController = null;
                this.pendingRequests = new Set();
                this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                this.sections = {
                    remarks: document.getElementById('remarksSection'),
                    loading: document.getElementById('loadingSection'),
                    results: document.getElementById('resultsSection'),
                    validation: document.getElementById('validationSection')
                };
                
                this.elements = {
                    diagnosticResults: document.getElementById('diagnosticResults'),
                    remarksInput: document.getElementById('remarks'),
                    startButton: document.getElementById('startAnalysis'),
                    validationButton: document.querySelector('.validation-button'),
                    secondaryValidationButton: document.querySelector('.validation-button.secondary')
                };

                Object.entries(this.sections).forEach(([key, element]) => {
                    if (!element) throw new Error(`Section ${key} manquante`);
                });
                
                Object.entries(this.elements).forEach(([key, element]) => {
                    if (!element) throw new Error(`Élément ${key} manquant`);
                });
            }

            setupEventListeners() {
                this.elements.startButton.addEventListener('click', 
                    () => this.handleStartAnalysis());

                this.elements.validationButton.addEventListener('click',
                    () => this.handleValidationClick());

                this.elements.secondaryValidationButton.addEventListener('click',
                    () => this.handleSecondaryValidationClick());

                window.addEventListener('unload', () => this.destroy());
            }

            async handleStartAnalysis() {
                try {
                    this.showLoading();
                    const data = await this.gatherPatientData();
                    Logger.debug('Analysis', 'Données collectées', data);
                    
                    const diagnosis = await this.requestDiagnosisWithRetry(data);
                    Logger.debug('Analysis', 'Diagnostic reçu', diagnosis);
                    
                    await this.displayAndSaveResults(diagnosis);
                } catch (error) {
                    Logger.error('Analysis', 'Erreur analyse', error);
                    this.handleError(error);
                }
            }

            async gatherPatientData() {
                try {
                    const documents = await this.storage.loadDocuments();
                    const validDocs = documents.filter(doc => 
                        this.storage.validateDocument(doc));
                    
                    Logger.debug('Documents', `${validDocs.length}/${documents.length} documents valides`);
                    
                    return {
                        personalInfo: this.loadStorageData('patient_personal_info'),
                        physicalActivity: this.loadStorageData('patient_physical_activity'),
                        symptoms: this.loadStorageData('patient_symptoms'),
                        documents: validDocs,
                        remarks: this.elements.remarksInput.value.trim()
                    };
                } catch (error) {
                    Logger.error('Data', 'Erreur collecte', error);
                    throw error;
                }
            }

            async requestDiagnosisWithRetry(data, attempt = 0) {
                try {
                    this.abortController = new AbortController();
                    this.pendingRequests.add(this.abortController);

                    const response = await Promise.race([
                        fetch(CONFIG.api, {
                            method: 'POST',
                            signal: this.abortController.signal,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type: 'diagnosis', data })
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), CONFIG.timeouts.request)
                        )
                    ]);

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(`API Error: ${response.status} - ${error}`);
                    }

                    const result = await response.json();
                    return this.validateDiagnosticResponse(result);

                } catch (error) {
                    if (error.name === 'AbortError') {
                        throw new Error('Requête annulée');
                    }

                    if (attempt < CONFIG.retries.maxAttempts - 1) {
                        const delay = Math.min(
                            CONFIG.retries.baseDelay * Math.pow(2, attempt),
                            CONFIG.retries.maxDelay
                        );
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return this.requestDiagnosisWithRetry(data, attempt + 1);
                    }

                    throw error;
                } finally {
                    this.pendingRequests.delete(this.abortController);
                }
            }

            validateDiagnosticResponse(response) {
                const diagnoses = response.diagnostics || response.diagnoses;
                
                if (!Array.isArray(diagnoses) || !diagnoses.length) {
                    throw new Error('Réponse invalide: pas de diagnostic');
                }

                diagnoses.forEach(diagnostic => {
                    const required = ['name', 'probability', 'shortDescription', 'details'];
                    required.forEach(field => {
                        if (!(field in diagnostic)) {
                            throw new Error(`Diagnostic invalide: ${field} manquant`);
                        }
                    });

                    if (!Array.isArray(diagnostic.details)) {
                        throw new Error('Diagnostic invalide: details incorrects');
                    }
                });

                return { diagnoses };
            }

            async displayAndSaveResults(data) {
                this.sections.loading.classList.add('hidden');
                this.elements.diagnosticResults.innerHTML = '';

                data.diagnoses.forEach(diagnostic => {
                    const element = this.createDiagnosticElement(diagnostic);
                    this.elements.diagnosticResults.appendChild(element);
                });

                this.sections.results.classList.remove('hidden');
                this.sections.validation.classList.remove('hidden');

                await this.saveResults();
                Logger.debug('UI', 'Résultats affichés et sauvegardés');
            }

            createDiagnosticElement(diagnostic) {
                const element = document.createElement('div');
                element.className = `diagnostic-item ${
                    diagnostic.probability >= 80 ? 'primary' : ''}`;
                element.innerHTML = this.getDiagnosticTemplate(diagnostic);
                return element;
            }

            getDiagnosticTemplate(diagnostic) {
                return `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold text-lg">
                                ${this.sanitizeString(diagnostic.name)}
                            </h3>
                            <p class="text-sm opacity-70">
                                ${this.sanitizeString(diagnostic.shortDescription)}
                            </p>
                        </div>
                        <span class="font-semibold">${diagnostic.probability}%</span>
                    </div>
                    <div class="probability-bar">
                        <div class="probability-bar-fill" 
                             style="width: ${diagnostic.probability}%">
                        </div>
                    </div>
                    <button class="expand-button" onclick="window.diagnosticManager.toggleDetails(this)">
                        Voir les détails
                        <svg class="w-5 h-5 transform transition-transform duration-200" 
                             fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" 
                                  stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div class="diagnostic-details">
                        ${diagnostic.details.map(detail => `
                            <div class="details-section">
                                <h4 class="font-medium mb-2">
                                    ${this.sanitizeString(detail.title)}
                                </h4>
                                <p class="text-sm opacity-80">
                                    ${this.sanitizeString(detail.content)}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            toggleDetails(button) {
                const details = button.nextElementSibling;
                const expanded = !details.classList.contains('expanded');
                details.classList.toggle('expanded');
                
                const arrow = button.querySelector('svg');
                arrow.style.transform = expanded ? 'rotate(180deg)' : '';
            }

            async saveResults() {
                try {
                    const data = {
                        remarks: this.elements.remarksInput.value.trim(),
                        diagnoses: Array.from(this.elements.diagnosticResults.children)
                            .map(this.extractDiagnosticData.bind(this))
                            .filter(Boolean)
                    };

                    if (!data.diagnoses.length) {
                        throw new Error('Aucun diagnostic à sauvegarder');
                    }

                    await this.storage.save(CONFIG.storage.keys.diagnosis, data);
                    Logger.debug('Storage', 'Résultats sauvegardés');
                    return true;
                } catch (error) {
                    Logger.error('Storage', 'Erreur sauvegarde', error);
                    return false;
                }
            }

            extractDiagnosticData(element) {
                try {
                    return {
                        name: element.querySelector('h3')?.textContent?.trim(),
                        probability: parseInt(
                            element.querySelector('.probability-bar-fill')
                                ?.style.width?.replace('%', '') || '0'
                        ),
                        shortDescription: element.querySelector('p.opacity-70')
                            ?.textContent?.trim(),
                        details: Array.from(element.querySelectorAll('.details-section'))
                            .map(section => ({
                                title: section.querySelector('h4')?.textContent?.trim(),
                                content: section.querySelector('p')?.textContent?.trim()
                            }))
                            .filter(detail => detail.title && detail.content)
                    };
                } catch (error) {
                    Logger.error('Data', 'Erreur extraction diagnostic', error);
                    return null;
                }
            }

            loadStorageData(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : {};
                } catch {
                    return {};
                }
            }

            sanitizeString(str) {
                if (!str || typeof str !== 'string') return '';
                return str.trim().replace(/[<>]/g, '');
            }

            showLoading() {
                this.sections.remarks.classList.add('hidden');
                this.sections.loading.classList.remove('hidden');
            }

            handleError(error) {
                this.sections.loading.classList.add('hidden');
                this.sections.remarks.classList.remove('hidden');
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 
                    'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
                errorDiv.innerHTML = `
                    <strong class="font-bold">Erreur!</strong>
                    <span class="block sm:inline">
                        ${this.sanitizeString(error.message)}
                    </span>
                `;
                
                this.sections.remarks.insertBefore(
                    errorDiv,
                    this.sections.remarks.firstChild
                );
                
                setTimeout(() => errorDiv.remove(), 5000);
            }

            async handleValidationClick() {
                try {
                    if (await this.saveResults()) {
                        window.location.href = 'treatment.html';
                    } else {
                        throw new Error('Erreur sauvegarde résultats');
                    }
                } catch (error) {
                    this.handleError(error);
                }
            }

            handleSecondaryValidationClick() {
                this.sections.results.classList.add('hidden');
                this.sections.validation.classList.add('hidden');
                this.sections.remarks.classList.remove('hidden');
            }

            destroy() {
                this.abortController?.abort();
                this.pendingRequests.forEach(req => req.abort());
                this.pendingRequests.clear();

                const buttons = [
                    this.elements.startButton,
                    this.elements.validationButton,
                    this.elements.secondaryValidationButton
                ];

                buttons.forEach(button => {
                    if (button) {
                        button.removeEventListener('click', () => this.handleStartAnalysis);
                        button.removeEventListener('click', () => this.handleValidationClick);
                        button.removeEventListener('click', () => this.handleSecondaryValidationClick);
                    }
                });

                window.removeEventListener('unload', () => this.destroy);
                Logger.debug('Lifecycle', 'Instance détruite');
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            window.diagnosticManager = new DiagnosticManager();
            
            // Chargement des données précédentes
            const savedData = window.PatientStorageManager.loadDocuments();
            if (savedData?.diagnoses?.length) {
                window.diagnosticManager.displayAndSaveResults(savedData);
                Logger.debug('Init', 'Données précédentes chargées');
            }

            Logger.debug('Init', 'DiagnosticManager initialisé');
        });
    </script>
</body>
</html>
