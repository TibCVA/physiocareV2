<script>
document.addEventListener('DOMContentLoaded', async () => {
    const { jsPDF } = window.jspdf; 
    window.patientManager = window.patientManager || new PatientManager();
    const pManager = window.patientManager;
    let patientData = pManager.loadPatientData();

    const mainContent = document.getElementById('mainContent');
    const initialMessage = document.getElementById('initialMessage');
    const loadingSection = document.getElementById('loadingSection');

    const hasDiagnosis = (patientData.diagnosis && patientData.diagnosis.length > 0);
    const hasTreatment = (patientData.treatment && Object.keys(patientData.treatment).length > 0);

    // Si pas de diagnostic
    if(!hasDiagnosis) {
        // On ne fait rien de plus : le message initial est déjà affiché par défaut.
        // Pas de return ici, on laisse juste ce cas tel quel.
    } else if(!hasTreatment) {
        // Diagnostic présent mais pas de traitement => on propose de générer le plan
        initialMessage.classList.add('hidden');
        const generateSection = document.createElement('div');
        generateSection.className = 'form-section text-center';
        generateSection.innerHTML = `
            <h2 class="text-xl font-semibold text-[var(--brand-dark)] mb-4">Générer le plan de traitement</h2>
            <p class="text-[var(--brand-dark)] opacity-80 mb-6">
                Cliquez sur le bouton ci-dessous pour générer un plan de traitement basé sur votre diagnostic.
            </p>
            <button class="generate-button" id="generateButton">Générer le plan</button>
        `;
        mainContent.appendChild(generateSection);

        const generateButton = document.getElementById('generateButton');
        generateButton.addEventListener('click', async ()=>{
            generateSection.classList.add('hidden');
            loadingSection.classList.remove('hidden');
            try {
                const data=await gatherPatientData();
                const result=await treatmentManager.getTreatment(data);
                loadingSection.classList.add('hidden');
                displayTreatment(result.treatmentPlan);
            } catch(e) {
                console.error(e);
                loadingSection.innerHTML='<p class="text-red-500">Erreur lors de la génération du traitement</p>';
            }
        });

    } else {
        // Traitement déjà existant
        initialMessage.classList.add('hidden');
        displayTreatment(patientData.treatment);
    }

    // Le reste de vos fonctions (displayTreatment, saveCurrentData, generatePDF, etc.) restent inchangées
});
</script>
